#
# API for Sidre
#
copyright:
  -
  - Copyright (c) 2017-2018, Lawrence Livermore National Security, LLC.
  -
  - Produced at the Lawrence Livermore National Laboratory
  -
  - LLNL-CODE-741217
  -
  - All rights reserved.
  -
  - This file is part of Axom.
  -
  - For details about use and distribution, please read axom/LICENSE.
  -

library: Sidre
# cxx_header: each class has its own header file
namespace: axom sidre

options:
  C_line_length: 1000
  F_module_per_class: False
  F_impl_filename_library_template: wrapf{library_lower}.F
  F_module_name_library_template: axom_{library_lower}
#  wrap_python: True

format:
  C_prefix: SIDRE_
  # Any C++ function which returns a string will be wrapped in
  # Fortran as a subroutine with an additional character argument
  # for the result.
#  F_string_result_as_arg: name

types:
  IndexType:
# defined in SidreTypes.hpp
    typedef  : int
    c_header : sidre/SidreTypes.h
    c_type   : SIDRE_IndexType
    cxx_type : IndexType

  SidreLength:
# defined in SidreTypes.hpp
    typedef  : long
    c_header : sidre/SidreTypes.h
    c_type   : SIDRE_SidreLength
    cxx_type : SidreLength

  TypeID:
    typedef  : int
    # enum for types
    c_header : sidre/SidreTypes.h
    cxx_header : sidre/SidreTypes.hpp
    cxx_type : TypeID
    c_to_cxx : getTypeID({c_var})
#    c_to_cxx : static_cast<TypeID>({c_var})
    cxx_to_c : static_cast<int>({cxx_var})


# XXX
# parameters:
#  InvalidID: IDTYPE -1

#declarations:
#  - namespace: axom
#    declarations:
#    - namespace: sidre
#      declarations:
classes:

  ####################################################################
      - name: DataStore
        cxx_header: sidre/DataStore.hpp
        format:
          F_derived_name:  SidreDataStore

        functions:
        - decl: DataStore()  +name(new)
        - decl: ~DataStore() +name(delete)
        - decl: Group * getRoot()
#        - decl: bool hasBuffer( IndexType idx ) const
        - decl:  Buffer * getBuffer( IndexType idx )
        - decl: Buffer * createBuffer()
          format:
            function_suffix: _empty
        - decl: Buffer * createBuffer( TypeID type, SidreLength num_elems )
          format:
            function_suffix: _from_type
          fortran_generic:
            num_elems:
            -  int
            -  long
          PY_error_pattern: PY_null_to_none

        - decl: void destroyBuffer( IndexType id )
#        - decl: void Destroybuffers()
#        - decl: Buffer * detachBuffer( const IndexType id )
        - decl: size_t getNumBuffers() const
#        - decl: IndexType getFirstValidBufferIndex() const
#        - decl: IndexType getNextValidBufferIndex(IndexType idx) const;

#        - decl: void info(Node &) const
        - decl: void print() const
#        - decl: void print(std::ostream& os) const

#        - decl: void createNativeLayout(Node &) const

        python:
          type: [ init, richcompare ]

      ####################################################################
      - name: Group
        cxx_header: sidre/Group.hpp
        format:
          F_derived_name:  SidreGroup

        functions:
        - decl: IndexType getIndex()
        - decl: const std::string& getName() const +len(MAXNAMESIZE)
        - decl: std::string getPath() const +len(MAXNAMESIZE)
        - decl: std::string getPathName() const +len(MAXNAMESIZE)
#        - decl: Group* getParent()
        - decl: const Group* getParent() const
#        - decl: DataStore* getDataStore() const
        - decl: const DataStore* getDataStore() const
        - decl: size_t getNumViews() const
        - decl: size_t getNumGroups() const
        - decl: bool hasView( const string& path ) const
        - decl: bool hasChildView( const string& name ) const
        - decl: bool rename( const string& new_name )
#        - decl: bool hasView( IndexType idx ) const
        - decl: View *getView( const std::string& path )
          format:
            function_suffix: _from_name
          PY_error_pattern: PY_null_to_none
#        - decl: View const * getView( const std::string& path ) const
        - decl: View *getView( const IndexType idx )
          format:
            function_suffix: _from_index
          PY_error_pattern: PY_null_to_none
#        - decl: View const *getView( const IndexType idx ) const
        - decl: IndexType getViewIndex(const std::string &name) const
        - decl: const std::string& getViewName(IndexType idx) const +len(MAXNAMESIZE)
          C_error_pattern: C_invalid_name
          PY_error_pattern: PY_invalid_name_idx

        - decl: IndexType getFirstValidViewIndex() const
        - decl: IndexType getNextValidViewIndex(IndexType idx) const

        - decl: View *createViewAndAllocate( const std::string& path, TypeID type, SidreLength num_elems)
          format:
            function_suffix: _nelems
          fortran_generic:
            num_elems:
            -  int
            -  long
          PY_error_pattern: PY_null_to_none

        - decl: View *createViewAndAllocate( const std::string& path, TypeID type, int ndims, SidreLength *shape+dimension)
          format:
            function_suffix: _shape
          PY_error_pattern: PY_null_to_none

#        - decl: View *createViewAndAllocate( const std::string& path, const DataType& dtype)

        - decl: View *createViewScalar( const std::string& path, ScalarType value)
          cxx_template:
            ScalarType:
            - int
            - long
            - float
            - double
          PY_error_pattern: PY_null_to_none

        - decl: View *createViewString( const std::string& path, const std::string& value)
          PY_error_pattern: PY_null_to_none

        - decl: View *createView( const string& path )
          format:
            function_suffix: _empty
          PY_error_pattern: PY_null_to_none

        - decl: View *createView( const std::string& path, TypeID type, SidreLength num_elems)
          format:
            function_suffix: _from_type
          fortran_generic:
            num_elems:
            -  int
            -  long
          PY_error_pattern: PY_null_to_none

        - decl: View *createView( const std::string& path, TypeID type, SidreLength num_elems, Buffer *buff)
          format:
            function_suffix: _from_type_and_buffer
          fortran_generic:
            num_elems:
            -  int
            -  long
          PY_error_pattern: PY_null_to_none

        - decl: View *createView( const std::string& path, TypeID type, SidreLength num_elems, void * external_ptr)
          format:
            function_suffix: _from_type_external
          fortran_generic:
            num_elems:
            -  int
            -  long
          PY_error_pattern: PY_null_to_none

        - decl: View *createView( const std::string& path, TypeID type, int ndims, SidreLength * shape+dimension)
          format:
            function_suffix: _from_shape
          PY_error_pattern: PY_null_to_none

        - decl: View *createView( const std::string& path, TypeID type, int ndims, SidreLength * shape+dimension, Buffer * buff)
          format:
            function_suffix: _from_shape_and_buffer
          PY_error_pattern: PY_null_to_none

        - decl: View *createView( const std::string& path, TypeID type, int ndims, SidreLength * shape+dimension, void * external_ptr)
          format:
            function_suffix: _from_shape_external
          PY_error_pattern: PY_null_to_none

#        - decl: View *createView( const std::string& path, const DataType& dtype)

        - decl: View *createView( const std::string& path, Buffer *buff)
          format:
            function_suffix: _into_buffer
          PY_error_pattern: PY_null_to_none

        - decl: View * createView( const std::string& path, void * external_ptr)
          format:
            function_suffix: _external
          PY_error_pattern: PY_null_to_none

        - decl: void destroyView( const std::string &path )
#        - decl: void destroyView( IndexType idx )
#        - decl: void destroyViews()
        - decl: void destroyViewAndData(const std::string &path)
          format:
            function_suffix: _name
        - decl: void destroyViewAndData(IndexType idx)
          format:
            function_suffix: _index
#        - decl: void destroyViewsAndData()
        - decl: View *moveView(View *view)
        - decl: View *copyView(View *view)

        - decl: bool hasGroup( const string& path )
#        - decl: bool hasGroup( IndexType idx )
        - decl: bool hasChildGroup( const string& name )
        - decl: Group * getGroup( const std::string& path )
          format:
            function_suffix: _from_name
          PY_error_pattern: PY_null_to_none
#        - decl: Group const * getGroup( const std::string& path ) const
        - decl: Group * getGroup( IndexType idx)
          format:
            function_suffix: _from_index
          PY_error_pattern: PY_null_to_none
#        - decl: Group const * getGroup(IndexType idx) const
        - decl: IndexType getGroupIndex(const std::string &name) const
        - decl: const std::string& getGroupName(IndexType idx) const +len(MAXNAMESIZE)
          C_error_pattern: C_invalid_name
          PY_error_pattern: PY_invalid_name_idx
        - decl: IndexType getFirstValidGroupIndex() const
        - decl: IndexType getNextValidGroupIndex(IndexType idx) const

        - decl: Group *createGroup( const string& path )
        - decl: void destroyGroup(const std::string &path)
          format:
            function_suffix: _name
        - decl: void destroyGroup(IndexType idx)
          format:
            function_suffix: _index
#        - decl: void destroyGroups()
        - decl: Group *moveGroup(Group *grp)
#        - decl: Group *copyGroup(Group *grp)

#        - decl: void info(Node &n) const
        - decl: void print() const
#        - decl: void printTree( const int level ) const
#        - decl: void createNativeLayout(Node &) const

#       - decl: void save(const std::string& obase, const std::string& protocol) const
#       - decl: void load(const std::string& obase,  const std::string& protocol)

        - decl: bool isEquivalentTo(const Group * other) const

        - decl: void save(const std::string& file_path, const std::string& protocol) const
#       - decl: void save(const hid_t& h5_id) const
#          format:
#           function_suffix: _hdf
        - decl: void load(const std::string& file_path, const std::string& protocol, bool preserve_contents = false)
#       - decl: void load(const hid_t& h5_id)
#          format:
#           function_suffix: _hdf
        - decl: void loadExternalData(const std::string& file_path)

        python:
          type: [ init, richcompare ]

      ####################################################################
      - name: Buffer
        cxx_header: sidre/Buffer.hpp
        format:
          F_derived_name:  SidreBuffer

        functions:
          - decl: IndexType getIndex() const
          - decl: size_t getNumViews() const
          - decl: Buffer* describe(TypeID type, SidreLength num_elems)
            return_this: True
            fortran_generic:
              num_elems:
              -  int
              -  long
#          - decl: Buffer* describe(const DataType& dtype)
          - decl: Buffer* allocate()
            format:
              function_suffix: _existing
            return_this: True
          - decl: Buffer* allocate(TypeID type, SidreLength num_elems)
            format:
              function_suffix: _from_type
            return_this: True
            fortran_generic:
              num_elems:
              -  int
              -  long
          - decl: Buffer * reallocate(SidreLength num_elems)
            return_this: True
            fortran_generic:
              num_elems:
              -  int
              -  long
          - decl: void* getVoidPtr()
          - decl: TypeID getTypeID() const
          - decl: size_t getNumElements() const
          - decl: size_t getTotalBytes() const
          - decl: size_t getBytesPerElement() const
#          - decl: Node& getNode()
#          - decl: const Node& getNode() const
#          - decl: View* getView(IndexType idx)
#          - decl: void info(Node& n) const
          - decl: void print() const

        python:
          type: [ init, richcompare ]

      ####################################################################
      - name: View
        cxx_header: sidre/View.hpp
        format:
          F_derived_name:  SidreView

        functions:
        - decl: View* allocate()
          format:
            function_suffix: _simple
          return_this: True
        - decl: View* allocate(TypeID type, SidreLength num_elems)
          format:
            function_suffix: _from_type
          return_this: True
          fortran_generic:
            num_elems:
            -  int
            -  long
#        - decl: View* allocate(const DataType& dtype)
        - decl: View * reallocate(SidreLength num_elems)
          return_this: True
          fortran_generic:
            num_elems:
            -  int
            -  long
#        - decl: View* reallocate(const DataType& dtype)
        - decl: View* apply()
          return_this: True

        - decl: View* attachBuffer(Buffer * buff)
          return_this: True
          format:
            function_suffix: _only

        - decl: View* attachBuffer(TypeID type, SidreLength num_elems, Buffer * buff)
          return_this: True
          format:
            function_suffix: _type
          fortran_generic:
            num_elems:
            -  int
            -  long

        - decl: View* attachBuffer(TypeID type, int ndims, SidreLength * shape+dimension, Buffer * buff)
          return_this: True
          format:
            function_suffix: _shape

        - decl: View* apply(SidreLength num_elems, SidreLength offset = 0, SidreLength stride = 1)
          default_arg_suffix:
            -  _nelems
            -  _nelems_offset
            -  _nelems_offset_stride
          return_this: True
        - decl: View* apply(TypeID type, SidreLength num_elems, SidreLength offset = 0, SidreLength stride = 1)
          default_arg_suffix:
            -  _type_nelems
            -  _type_nelems_offset
            -  _type_nelems_offset_stride
          return_this: True
        - decl: View * apply( TypeID type, int ndims, SidreLength * shape+dimension )
          format:
            function_suffix: _type_shape
          return_this: True
#        - decl: View* apply(const DataType& dtype)
        - decl: bool hasBuffer() const
        - decl: bool isExternal() const
        - decl: bool isAllocated()
        - decl: bool isApplied() const
        - decl: bool isDescribed() const
        - decl: bool isEmpty() const
        - decl: bool isOpaque() const
        - decl: bool isScalar() const
        - decl: bool isString() const
        - decl: IndexType getIndex()
        - decl: const std::string& getName() const +len(MAXNAMESIZE)
        - decl: std::string getPath() const +len(MAXNAMESIZE)
        - decl: std::string getPathName() const +len(MAXNAMESIZE)
        - decl: Buffer* getBuffer()
#        - decl: Buffer const* getBuffer() const
        - decl: void * getVoidPtr() const
#        - decl: Node& getNode()
#        - decl: const Node& getNode() const
#        - decl: Node::Value getValue()

#               template<typename ScalarType>
        - decl: void setScalar(ScalarType value)
          cxx_template:
            ScalarType:
            - int
            - long
            - float
            - double

        - decl: View * setExternalDataPtr(void * external_ptr)
          return_this: True
          format:
            function_suffix: _only

        - decl: View * setExternalDataPtr(TypeID type, SidreLength num_elems, void * external_ptr)
          return_this: True
          format:
            function_suffix: _type
          fortran_generic:
            num_elems:
            -  int
            -  long

        - decl: View * setString(const std::string& value)
          return_this: True

        - decl: View * setExternalDataPtr(TypeID type, int ndims, SidreLength * shape+dimension, void * external_ptr)
          return_this: True
          format:
            function_suffix: _shape

        - decl: const char * getString() +len(MAXNAMESIZE)
          format:
            F_string_result_as_arg: name

#               template<typename DataType>
        - decl: DataType getData()
          cxx_template:
            DataType:
            - int
            - long
            - float
            - double

#    #    - decl: const Schema& getSchema() const
        - decl: Group* getOwningGroup()
#        - decl: Group const* getOwningGroup() const
        - decl: TypeID getTypeID() const
        - decl: size_t getTotalBytes() const
        - decl: size_t getBytesPerElement() const
        - decl: size_t getNumElements() const
        - decl: size_t getOffset() const
        - decl: size_t getStride() const
        - decl: int getNumDimensions() const
        - decl: int getShape(int ndims, SidreLength * shape+dimension+intent(OUT) ) const
        - decl: bool rename( const string& new_name ) 
#        - decl: void info(Node& n) const
        - decl: void print() const
#        - decl: void createNativeLayout(Node &) const

        python:
          type: [ init, richcompare ]


#    #####################################################################

functions:
      - decl: bool nameIsValid(const std::string& name)
         # The concept of a valid name is different for C++, C and Fortran
        options:
          F_string_len_trim: false
        format:
          C_code:  return name != NULL;
          F_code:  '{F_result} = name .ne. " "'


######################################################################
patterns:
    C_invalid_name: |
        if (! nameIsValid({cxx_var})) {{
            return SIDRE_InvalidName;
        }}
    # return a blank field string if an error occurs
    C_invalid_name_buf: |
        if (! nameIsValid({cxx_var})) {{
            std::memset({c_var}, ' ', {c_var_len});
            return;
        }}
    PY_invalid_name: |
        if (! nameIsValid({cxx_var})) {{
            PyErr_SetString(PyExc_KeyError, "XXX - need name");
            return NULL;
        }}
    # report the invalid index, assume local variable idx
    PY_invalid_name_idx: |
        if (! nameIsValid({cxx_var})) {{
            Py_RETURN_NONE;
        }}
#            PyErr_SetObject(PyExc_KeyError, PyInt_FromLong(idx));
#            return NULL;
    # Convert NULL to None
    PY_null_to_none: |
        if ({cxx_var} == AXOM_NULLPTR) {{
            Py_RETURN_NONE;
        }}



# Files which contain code to be inserted into generated code
splicer:
  c:
  -  c_fortran/csidresplicer.c
  f:
  -  c_fortran/fsidresplicer.f
  -  genfsidresplicer.f
  py:
  -  python/pysidresplicer.c
